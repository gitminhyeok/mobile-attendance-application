{% extends "base.html" %}

{% block title %}Magnus - í™ˆ{% endblock %}

{% block content %}
<div class="flex flex-col items-center space-y-8 w-full max-w-md">
    <h1 class="text-3xl font-bold text-gray-800">Magnus</h1>
    
    {% if uid %}
        <p class="text-lg">ì•ˆë…•í•˜ì„¸ìš”, <span class="font-bold">{{ nickname }}</span>ë‹˜!</p>
        
        <!-- Attendance Button Area -->
        <div class="relative group">
            {% if already_attended %}
                <button disabled class="w-64 h-64 rounded-full bg-green-500 shadow-xl flex items-center justify-center cursor-not-allowed">
                    <div class="text-white text-center">
                        <p class="text-4xl font-bold">ì¶œì„ ì™„ë£Œ</p>
                        <p class="mt-2 text-sm text-green-100">ì˜¤ëŠ˜ë„ ê³ ìƒí•˜ì…¨ìŠµë‹ˆë‹¤!</p>
                    </div>
                </button>
            {% elif time_status == 'closed' %}
                <button disabled class="w-64 h-64 rounded-full bg-gray-400 shadow-inner flex items-center justify-center cursor-not-allowed">
                    <div class="text-white text-center">
                        <p class="text-3xl font-bold">ì¶œì„ ë¶ˆê°€</p>
                        <p class="mt-2 text-sm text-gray-200">{{ time_msg }}</p>
                    </div>
                </button>
            {% elif not is_ip_valid %}
                <button disabled class="w-64 h-64 rounded-full bg-red-400 shadow-inner flex items-center justify-center cursor-not-allowed">
                    <div class="text-white text-center">
                        <p class="text-3xl font-bold">ìœ„ì¹˜ ì˜¤ë¥˜</p>
                        <p class="mt-2 text-sm text-red-100">ì§€ì •ëœ ì™€ì´íŒŒì´ê°€ ì•„ë‹™ë‹ˆë‹¤</p>
                    </div>
                </button>
            {% else %}
                <!-- Active Button -->
                <button onclick="doAttendance()" id="attend-btn" class="w-64 h-64 rounded-full bg-blue-500 hover:bg-blue-600 shadow-2xl flex items-center justify-center transition-transform transform active:scale-95">
                    <div class="text-white text-center">
                        <p class="text-4xl font-bold">ì¶œì„í•˜ê¸°</p>
                        <p class="mt-2 text-sm text-blue-100">
                            {% if time_status == 'late' %}í˜„ì¬ ì§€ê° ì²˜ë¦¬ë©ë‹ˆë‹¤{% else %}ì§€ê¸ˆ ì¶œì„í•˜ì„¸ìš”!{% endif %}
                        </p>
                    </div>
                </button>
                <div class="absolute inset-0 rounded-full bg-blue-500 opacity-20 animate-ping pointer-events-none"></div>
            {% endif %}
        </div>

    {% else %}
        <!-- Login Button -->
        <div class="flex flex-col items-center">
            <p class="mb-4 text-gray-600">ì¶œì„ì„ í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <a href="/login/kakao" class="bg-yellow-400 text-gray-900 font-bold py-3 px-8 rounded-lg shadow-md hover:bg-yellow-300 transition flex items-center">
                <span class="mr-2">ğŸ’¬</span> ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸
            </a>
        </div>
    {% endif %}

    <div class="text-center text-gray-600 mt-4">
        {% if uid %}
            <p class="text-xs text-gray-400">ë‚´ IP: {{ client_ip }}</p>
        {% endif %}
    </div>
</div>

<script>
    async function doAttendance() {
        const btn = document.getElementById('attend-btn');
        btn.disabled = true;
        
        try {
            const response = await fetch('/attendance', { method: 'POST' });
            const data = await response.json();
            
            if (response.ok) {
                alert(data.message);
                window.location.reload();
            } else {
                alert("ì˜¤ë¥˜: " + data.message);
                btn.disabled = false;
            }
        } catch (error) {
            console.error('Error:', error);
            alert("í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            btn.disabled = false;
        }
    }
</script>
{% endblock %}